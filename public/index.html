<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RAG + Ollama Chat (SSE)</title>
    
    <!-- Markdown íŒŒì„œ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- XSS ë°©ì§€ Sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <!-- (ì„ íƒ) ì½”ë“œ í•˜ì´ë¼ì´íŠ¸ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>

    <style>
        body { font-family: ui-sans-serif, system-ui, -apple-system; margin:0; background:#f6f7f9; }
        .wrap { max-width: 860px; margin: 40px auto; background: #fff; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.08); overflow: hidden; }
        header { padding: 16px 20px; font-weight: 700; border-bottom: 1px solid #eee; display:flex; gap:12px; align-items:center; }
        header input, header select { padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
        #chat { padding: 20px; height: 64vh; overflow: auto; }
        .msg { margin: 10px 0; line-height: 1.55; }
        .user { text-align: right; }
        .bubble.ai p { margin: .4em 0; }
        .bubble.user { background:#2563eb; color:white; }
        .bubble.ai {
            background:#f1f5f9;
            color:#111827;
            padding: 10px 16px;
            border-radius: 16px 16px 16px 4px;
            display: inline-block;
            max-width: 70%;
            min-width: 80px;
            width: fit-content;
            word-break: break-word;
        }
        .bubble.user {
            background:#2563eb;
            color:white;
            padding: 10px 16px;         /* â¬… ì—¬ë°± ì¡°ê¸ˆ ë” ì£¼ê¸° */
            border-radius: 16px 16px 4px 16px; /* â¬… ëª¨ì„œë¦¬ë„ ë‘¥ê¸€ê²Œ */
            display: inline-block;
            max-width: 70%;             /* â¬… í™”ë©´ ì°¨ì§€ ìµœëŒ€í­ (ê°€ë³€) */
            min-width: 80px;            /* â¬… ë„ˆë¬´ ì¢ì•„ì§€ì§€ ì•Šë„ë¡ ìµœì†Œí­ */
            width: fit-content;         /* â¬… ë‚´ìš© ê¸¸ì´ì— ë§ê²Œ ìë™ ì¡°ì ˆ */
            word-break: break-word;     /* â¬… ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ */
            overflow-wrap: anywhere;           /* ê¸´ ìˆ«ì/URLë„ ì¤„ë°”ê¿ˆ */
        }
        .msg.user .bubble { margin-right: auto; }    /* â¬… ì‚¬ìš©ì ì…ë ¥ í…ìŠ¤íŠ¸ì˜ ì •ë ¬ */
        .msg.ai   .bubble { margin-right: auto; }    /* â¬… ai ì¶œë ¥ í…ìŠ¤íŠ¸ì˜ ì •ë ¬ */
        form { display:flex; gap:8px; padding: 12px; border-top:1px solid #eee; background:#fafafa; }
        input[type="text"], button, select { font-size: 16px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
        input[type="text"] { flex:1; }
        button { background:#111827; color:white; cursor:pointer; }
        button:disabled { opacity:.6; cursor:not-allowed; }

        /* ë¬¼ê²°(Wave) ë¡œë”© ì• ë‹ˆë©”ì´ì…˜: í…ìŠ¤íŠ¸ì— ì›€ì§ì´ëŠ” ê·¸ë¼ë””ì–¸íŠ¸ */
        .wave {
            display:inline-block;                /* í…ìŠ¤íŠ¸ í­ë§Œí¼ë§Œ ë°°ê²½ ì ìš© */
            background: linear-gradient(90deg, rgba(0,0,0,0.15), rgba(0,0,0,0.35), rgba(0,0,0,0.15));
            background-size:200% 100%;
            -webkit-background-clip:text;       /* í¬ë¡¬/ì—£ì§€/ì‚¬íŒŒë¦¬ */
            background-clip:text;
            color:transparent;                   /* íŒŒì´ì–´í­ìŠ¤ */
            -webkit-text-fill-color:transparent; /* í¬ë¡¬/ì—£ì§€/ì‚¬íŒŒë¦¬ - ì¤‘ìš”! */
            animation:waveSlide 1.2s linear infinite;
        }
        @keyframes waveSlide {
            0% { background-position: 200% 0 }
            100% { background-position: 0% 0 }
        }

        .bubble p { margin: .25em 0; }
        .bubble p:first-child { margin-top: 0; }
        .bubble p:last-child  { margin-bottom: 0; }

        .bubble.ai pre {
            background: #0f172a0d;  /* ì•„ì£¼ ì˜…ì€ ë°°ê²½ */
            padding: 10px 12px;
            border-radius: 10px;
            overflow: auto;
        }
        .bubble.ai code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            font-size: 0.95em;
        }
        .bubble.ai table {
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
        }
        .bubble.ai table th, .bubble.ai table td {
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
        }
        .bubble.ai ul, .bubble.ai ol { padding-left: 1.25em; }
        /* ë§í’ì„  ì•ˆ ë¦¬ìŠ¤íŠ¸ ê°„ê²© ì¤„ì´ê¸° */
        .bubble.ai ul { margin: .3em 0; padding-left: 1.2em; }
        .bubble.ai li { margin: .15em 0; }
        .bubble.ai p { margin: .4em 0; }
        .bubble .md { white-space: normal; }
    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <div>RAG + Ollama Chat (SSE)</div>
            <select id="model">
            <option value="llama3.1" selected>llama3.1</option>
            <option value="mistral">mistral</option>
            <option value="gemma">gemma</option>
            </select>
            <input id="server" value="http://127.0.0.1:8000" title="FastAPI ì„œë²„ ì£¼ì†Œ" />
        </header>
        <div id="chat"></div>
        <form id="composer">
            <input id="input" type="text" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" autocomplete="off" />
            <button type="submit">Send</button>
        </form>
    </div>

    <script>
        const chatEl = document.getElementById('chat');
        const form = document.getElementById('composer');
        const input = document.getElementById('input');
        const modelSel = document.getElementById('model');
        const serverInput = document.getElementById('server');

        // ëŒ€í™” íˆìŠ¤í† ë¦¬ (ì„œë²„ë¡œ í•¨ê»˜ ì „ì†¡)
        const history = [];
        let currentES = null;

        /* ========= Helpers ========= */

        // ìˆ«ìì²˜ëŸ¼ ë³´ì´ëŠ”ì§€(í‘œ í—¤ë” íŒë³„ì— ì‚¬ìš©)
        function looksNumeric(t) {
            return /^[\d,\.\-\s%]+$/.test(t) && !/[A-Za-zê°€-í£]/.test(t);
        }

        // ì…€ ì •ë¦¬
        function normCell(t) {
            return t.replace(/\s+/g, " ").trim();
        }

        // í•œ ì¤„(ë˜ëŠ” ì—°ì† ë¸”ë¡)ë¡œ ë¶™ì€ íŒŒì´í”„ ë°ì´í„°ë¥¼ ë§ˆí¬ë‹¤ìš´ í‘œë¡œ ì¬êµ¬ì„±
        function rebuildPipeBlock(block) {
            // "||"ë¡œ ì¤„ ë°”ê¿ˆí•´ ì˜¨ ê²½ìš° ë³´ì •
            block = block.replace(/\|\|/g, "|\n|").replace(/\r?\n/g, "");

            const tokens = block
                .split("|")
                .map(normCell)
                .filter(Boolean);

            let out = [];
            let i = 0;

            while (i < tokens.length) {
                let best = null; // {m, rows, score}
                for (let m = 2; m <= 10; m++) {
                    const remain = (tokens.length - i) % m;
                    const rows = Math.floor((tokens.length - i) / m);
                    if (rows < 2) continue;

                    const header = tokens.slice(i, i + m);
                    const nonNum = header.filter(t => !looksNumeric(t)).length;

                    // ì”ì—¬ 0, í—¤ë” ë¹„ìˆ«ì ë§ìŒ, í–‰ìˆ˜ ë§ìŒì— ê°€ì 
                    const score = (remain === 0 ? 100 : 50 - remain) + nonNum * 2 + rows;
                    if (!best || score > best.score) best = { m, rows, score };
                }

                if (!best) {
                    out.push(tokens.slice(i).join(" | "));
                    break;
                }

                const { m, rows } = best;
                let tableLines = [];
                for (let r = 0; r < rows; r++) {
                    const row = tokens.slice(i + r * m, i + (r + 1) * m);
                    tableLines.push("|" + row.join("|") + "|");
                }
                const sep = "|" + Array(m).fill("---").join("|") + "|";
                tableLines.splice(1, 0, sep);
                out.push(tableLines.join("\n"));
                i += rows * m;
            }

            return "\n" + out.join("\n\n") + "\n";
        }

        /* ========= Main ========= */

        function preprocessMarkdown(md, {
            sentenceSpace = true, // ë§ˆì¹¨í‘œ/ë¬¼ìŒí‘œ/ëŠë‚Œí‘œ ë’¤ "ê³µë°±"ë§Œ ë³´ì¥
            bulletBreak   = true, // ë¶ˆë¦¿ì´ ë¬¸ì¥ ë’¤ì— ë¶™ì–´ì˜¤ë©´ ì¤„ë°”ê¿ˆ
            numberList    = true, // "1. " ê°™ì€ ë²ˆí˜¸ ëª©ë¡ ë³´ì •
            keepUnits     = true, // 'ì›/ë§Œì›/%/ì–µ' ë’¤ ê°œí–‰ ê¸ˆì§€
            fixTables     = true, // ì¸ë¼ì¸ íŒŒì´í”„ í‘œ ì¬êµ¬ì„±
            maxBlank      = 2     // ì—°ì† ë¹ˆ ì¤„ ìµœëŒ€
        } = {}) {
            if (!md) return "";
            md = String(md).replace(/\r\n?/g, "\n").replace(/\t/g, " ");

            /* 0) ì½”ë“œ ë¸”ë¡/ì¸ë¼ì¸ ë³´í˜¸ */
            const stash = [];
            md = md.replace(/```([\s\S]*?)```/g, (m) => {
                const k = `__FENCE_${stash.length}__`;
                stash.push({ k, m });
                return k;
            });
            md = md.replace(/`([^`]+)`/g, (m) => {
                const k = `__CODE_${stash.length}__`;
                stash.push({ k, m });
                return k;
            });

            /* 1) ìˆ«ì í¬ë§· ë³´ì • (chunkë¡œ ìª¼ê°œì§„ ê²ƒë“¤ ë³µì›) */
            // ì†Œìˆ˜ì : "84. 9251" -> "84.9251"
            md = md.replace(/(\d+)\s*\.\s*(\d+)/g, "$1.$2");
            // ì²œë‹¨ìœ„ ì‰¼í‘œ: "225, 626, 000" -> "225,626,000"
            md = md
                .replace(/(\d)\s+,/g, "$1,")               // ìˆ«ì+ê³µë°±+ì½¤ë§ˆ -> ìˆ«ì+ì½¤ë§ˆ
                .replace(/,(\s+)(\d{3}\b)/g, ",$2");       // ì½¤ë§ˆ ë’¤ ê³µë°± ì œê±°(3ìë¦¬ ê·¸ë£¹)

            /* 2) êµµê²Œ(**â€¦**) ì•ˆ/ì£¼ë³€ ì¤„ë°”ê¿ˆ ì œê±° */
            md = md.replace(/\*\*\s*([\s\S]*?)\s*\*\*/g, (_, inner) => `**${inner.replace(/\s+/g, " ").trim()}**`);

            /* 3) ì¸ë¼ì¸ í‘œ ì¬êµ¬ì„± */
            if (fixTables) {
                // íŒŒì´í”„ê°€ ë‹¤ìˆ˜ í¬í•¨ëœ "í•œ ì¤„"ì„ í‘œ í›„ë³´ë¡œ ê°„ì£¼
                md = md.replace(
                    /(?:^|\n)([^ \n]*\|[^ \n]*\|[^ \n]*\|[^ \n]*\|[^ \n]*[^ \n|]*)(?=\n|$)/g,
                    (m, block) => {
                        const pipes = (block.match(/\|/g) || []).length;
                        if (pipes < 5) return m;       // íŒŒì´í”„ê°€ ì ìœ¼ë©´ ë¬´ì‹œ
                        return rebuildPipeBlock(block);
                    }
                );
            }

            /* 4) ë‹¨ìœ„ ë’¤ ê°œí–‰ ê¸ˆì§€ (ì›/ë§Œì›/ì–µ/%) */
            if (keepUnits) {
                md = md.replace(/(ì›|ë§Œì›|ì–µ|%)[ \t]*\n[ \t]*/g, "$1 ");
            }

            /* 5) ë§ˆì¹¨í‘œ/ëŠë‚Œí‘œ/ë¬¼ìŒí‘œ ë’¤ëŠ” "ê³µë°±"ë§Œ ë³´ì¥ (ì¤„ë°”ê¿ˆ X)
                    - ì†Œìˆ˜ì (ìˆ«ì.ìˆ«ì)ì€ ì œì™¸, ì´ë¯¸ ê³µë°±/ê°œí–‰/ë¬¸ì¥ê¸°í˜¸ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ */
            if (sentenceSpace) {
                md = md
                .replace(/(?<!\d)\.(?=[^\d\s.!?:;])/g, ". ") // ìˆ«ì ì•„ë‹Œ ë§ˆì¹¨í‘œ ë’¤ ê³µë°±
                .replace(/([!?])(?![\s.!?:;])/g, "$1 ");     // !? ë’¤ ê³µë°±
            }

            /* 6) ë¶ˆë¦¿/ë²ˆí˜¸ ëª©ë¡ì´ ë¬¸ì¥ ë’¤ì— ë¶™ì–´ì˜¤ë©´ ì¤„ë°”ê¿ˆ */
            if (bulletBreak) {
                md = md.replace(/([^\n])\s*([\-*â€¢Â·â€“]\s+)/g, "$1\n$2");
            }
            if (numberList) {
                md = md
                    .replace(/([^\n])\s*(\d{1,3}\.\s+)/g, "$1\n$2")
                    .replace(/([^\n])\s*(\d{1,3}\)\s+)/g, "$1\n$2")
                    .replace(/([^\n])\s*(\(\d{1,3}\)\s+)/g, "$1\n$2");
            }

            /* 7) ê³¼ë„í•œ ê³µë°±/ê°œí–‰ ì •ë¦¬ (ì‰¼í‘œ ë’¤ ê°œí–‰ì€ ì ˆëŒ€ ë§Œë“¤ì§€ ì•ŠìŒ) */
            md = md
                .replace(/[ \t]+\n/g, "\n")                            // ì¤„ ë ê³µë°± ì œê±°
                .replace(/\n{2,}([\-*â€¢Â·â€“]\s)/g, "\n$1")                // ë¦¬ìŠ¤íŠ¸ ì‚¬ì´ ê³¼ê°œí–‰ ì¶•ì•½
                .replace(new RegExp(`\\n{${maxBlank + 1},}`, "g"), "\n".repeat(maxBlank))
                .trim();

            /* 8) ë³´í˜¸í–ˆë˜ ì½”ë“œ ë³µì› */
            for (const f of stash) md = md.replace(f.k, f.m);

            return md;
        }


        // ë§ˆí¬ë‹¤ìš´ â†’ ì•ˆì „í•œ HTMLë¡œ ë Œë”
        function renderMarkdown(md, el) {
            marked.setOptions({
                gfm: true,
                breaks: true,          // ë‹¨ì¼ ê°œí–‰ë„ <br>ë¡œ
                mangle: false,
                headerIds: false
            });

            const html = marked.parse(preprocessMarkdown(md) || "");
            const safe = DOMPurify.sanitize(html);
            el.innerHTML = safe;

            // ë§í¬ ìƒˆì°½
            el.querySelectorAll('a[href]').forEach(a => {
                a.setAttribute('target', '_blank');
                a.setAttribute('rel', 'noopener noreferrer');
            });

            // ì½”ë“œ í•˜ì´ë¼ì´íŠ¸
            el.querySelectorAll('pre code').forEach(block => {
                try { hljs.highlightElement(block); } catch {}
            });
        }

        function addBubble(role, text) {
            const row = document.createElement('div');
            row.className = 'msg ' + (role === 'user' ? 'user' : 'ai');

            const bubble = document.createElement('div');
            bubble.className = 'bubble ' + (role === 'user' ? 'user' : 'ai');

            // ì—¬ê¸°ë§Œ ë³€ê²½: ì²˜ìŒë¶€í„° ë§ˆí¬ë‹¤ìš´ ë Œë” ê°€ëŠ¥
            //renderMarkdown(text, bubble);

            // ğŸ”¹ ë§ˆí¬ë‹¤ìš´ ì „ìš© ì»¨í…Œì´ë„ˆ
            const md = document.createElement('div');
            md.className = 'md';
            bubble.appendChild(md);

            // ì‚¬ìš©ì ë©”ì‹œì§€ë‚˜ ì´ˆê¸° í…ìŠ¤íŠ¸ê°€ ìˆì„ ë•Œë§Œ ë Œë”
            if (role === 'assistant' && (text === '' || text == null)) {
                // ì•„ë¬´ê²ƒë„ ê·¸ë¦¬ì§€ ì•ŠìŒ (ë¡œë”ê°€ ë“¤ì–´ì˜¬ ìë¦¬)
            } else {
                renderMarkdown(text ?? '', md);
            }

            row.appendChild(bubble);
            chatEl.appendChild(row);
            chatEl.scrollTop = chatEl.scrollHeight;
            return bubble;
        }

        function closeSSE(es) {
            if (es && es.readyState !== EventSource.CLOSED) {
                es.close();
            }
        }

        function clearWave(e1) {
            if (!e1) return;              // ë°©ì–´
            const w = e1.querySelector('.wave');
            if (w) w.remove();
        }

        async function sendMessage(userText) {
            // í™”ë©´ & íˆìŠ¤í† ë¦¬ ë°˜ì˜
            addBubble('user', userText);
            history.push({ role: 'user', content: userText });

            // ìƒˆë¡œ ì—´ê¸° ì „ì— í•­ìƒ ì´ì „ ì—°ê²° ì •ë¦¬
            if (currentES) { closeSSE(currentES); currentES = null; }

            // ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ë³€ìˆ˜ëŠ” ìµœìƒë‹¨ì— ì„ ì–¸(í˜¸ì´ìŠ¤íŒ…/TDZ íšŒí”¼)
            let gotAny = false;
            let started = false;
            let aiMd = "";
            let timeoutId = null;      // ë¨¼ì € ì„ ì–¸ (í•¸ë“¤ëŸ¬ì—ì„œ ì°¸ì¡° ê°€ëŠ¥)

            // SSEìš© íƒ€ì´í•‘ wave ë²„ë¸”
            const aiBubble = addBubble('assistant', ''); // ë¹„ì›Œì„œ ìƒì„±
            //aiBubble.innerHTML = '<span class="wave">ë‹µë³€ ìƒì„± ì¤‘â€¦</span>';
            const mdEl = aiBubble.querySelector('.md');  // ğŸ”¹ ë§ˆí¬ë‹¤ìš´ ì „ìš© ì—˜ë¦¬ë¨¼íŠ¸
            const loader = document.createElement('span');  // ë¡œë” ì—˜ë¦¬ë¨¼íŠ¸
            loader.className = 'wave';
            loader.textContent = 'ë‹µë³€ ìƒì„± ì¤‘â€¦';
            aiBubble.appendChild(loader);

            const server = serverInput.value.replace(/\/$/, '');
            const sid = Date.now().toString(36) + Math.random().toString(36).slice(2);
            const qs = new URLSearchParams({
                query: userText,
                model: modelSel.value,
                history: JSON.stringify(history),
                sid,
            });
            const url = `${server}/api/chat_sse?${qs.toString()}`;

            // EventSource ì‹œì‘
            let es;
            try {
                es = new EventSource(url);
                currentES = es;
                
                // ìƒì„± ì§í›„, ê°€ì¥ ë¨¼ì € í•¸ë“¤ëŸ¬ë¥¼ ë¶™ì¸ë‹¤
                // ì—¬ê¸°ì„œë¶€í„°ë§Œ ev ì‚¬ìš© (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‚´ë¶€!)
                es.addEventListener('message', (ev) => {
                    console.log('[SSE message]', ev.data); // log ì¶”ê°€ (2025. 8. 24.)
                    if (!ev.data) return;
                    gotAny = true;

                    if (!started) {
                        started = true;
                        aiMd = ev.data;
                        // ë¡œë”©ë§Œ ì œê±° í›„ ì‹¤ì œ ë§ˆí¬ë‹¤ìš´ ë Œë” (ë§í’ì„  ë¹„ìš°ì§€ ì•ŠìŒ)
                        clearWave(aiBubble);
                        //renderMarkdown(aiMd, aiBubble);
                        renderMarkdown(aiMd, mdEl);   // ğŸ”¹ md ì»¨í…Œì´ë„ˆì—ë§Œ ë Œë”
                    } else {
                        aiMd += ev.data;
                        //renderMarkdown(aiMd, aiBubble);
                        renderMarkdown(aiMd, mdEl);   // ğŸ”¹ md ì»¨í…Œì´ë„ˆì—ë§Œ ë Œë”
                    }
                    chatEl.scrollTop = chatEl.scrollHeight;
                });

                es.addEventListener('model_error', (ev) => {
                    clearTimeout(timeoutId);
                    closeSSE(es); if (currentES === es) currentES = null;
                    clearWave(aiBubble);
                    aiMd = `**[ëª¨ë¸ ì˜¤ë¥˜]** ${ev?.data || ''}`;
                    //renderMarkdown(aiMd, aiBubble);
                    renderMarkdown(aiMd, mdEl);
                    history.push({ role: 'assistant', content: aiMd });
                });

                es.addEventListener('done', () => {
                    clearTimeout(timeoutId);
                    closeSSE(es); if (currentES === es) currentES = null;
                    clearWave(aiBubble);
                    //renderMarkdown(aiMd || "[ì‘ë‹µ ì—†ìŒ]", aiBubble);
                    renderMarkdown(aiMd || "[ì‘ë‹µ ì—†ìŒ]", mdEl);
                    history.push({ role: 'assistant', content: aiMd });
                });

                // ë„¤íŠ¸ì›Œí¬/HTTP ì˜¤ë¥˜(4xx/5xx í¬í•¨) â†’ ìë™ ì¬ì—°ê²°ì´ ê³„ì†ë˜ë©´ â€œë¬´í•œ ë£¨í”„ì²˜ëŸ¼â€ ë³´ì„
                es.onerror = () => {
                    clearTimeout(timeoutId);
                    closeSSE(es); if (currentES === es) currentES = null;
                    clearWave(aiBubble);
                    if (!gotAny) {
                        aiMd = "**[SSE ì˜¤ë¥˜]** ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤.";
                        //renderMarkdown(aiMd, aiBubble);
                        renderMarkdown(aiMd, mdEl);
                        history.push({ role: 'assistant', content: aiMd });
                    }
                    // EventSourceëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì¬ì—°ê²° ì‹œë„ â†’ closeë¡œ ë°˜ë“œì‹œ ëŠì–´ì¤Œ
                };

                // ë¦¬ìŠ¤ë„ˆ ë¶€ì°© ì™„ë£Œë¥¼ ì„œë²„ì— í†µì§€ (í•¸ë“œì…°ì´í¬)
                try {
                    const resp = await fetch(`${server}/api/sse_ready`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sid }),
                    });

                    if (!resp.ok) {
                        console.error('[sse_ready] HTTP', resp.status);
                    } else {
                        const jr = await resp.json().catch(()=>({}));
                        if (!jr.ok) console.error('[sse_ready] resp', jr);
                    }
                } catch (e) {
                    console.error('[sse_ready] failed', e);
                }
            } catch (e) { 
                clearWave(aiBubble);
                //renderMarkdown("**[SSE ìƒì„± ì‹¤íŒ¨]** " + (e?.message || e), aiBubble);
                renderMarkdown("**[SSE ìƒì„± ì‹¤íŒ¨]** " + (e?.message || e), mdEl);
                history.push({ role: 'assistant', content: aiBubble.textContent });
                return;
            }

            // 60ì´ˆ íƒ€ì„ì•„ì›ƒ ë³´í˜¸ì¥ì¹˜
            timeoutId = setTimeout(() => {
                closeSSE(es);
                if (currentES === es) currentES = null;
                //aiBubble.classList.remove('wave');
                clearWave(aiBubble);
                //renderMarkdown("**[íƒ€ì„ì•„ì›ƒ]** ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.", aiBubble);
                renderMarkdown("**[íƒ€ì„ì•„ì›ƒ]** ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.", mdEl);
                history.push({ role: 'assistant', content: aiBubble.textContent });
            }, 60000);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            form.querySelector('button').disabled = true;
            try {
                await sendMessage(text);
            } finally {
                form.querySelector('button').disabled = false;
                input.focus();
            }
        });
    </script>
</body>
</html>